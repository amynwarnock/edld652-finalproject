---
title: "EDLD 652 Final Project Draft"
author: "Ksenia Gordeeva, Rebeccca Gordon, Amy Warnock"
date: "2/21/2022"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      eval = TRUE,
                      message = FALSE,
                      warning = FALSE)


library(edld652)
library(tidyverse)
library(here)
library(janitor)
library(skimr)
library(rio)
#install.packages("fuzzyjoin")
library(fuzzyjoin)
library(viridis)
library(patchwork)
library(albersusa)
library(ggridges)
#install.packages("biscale")
library(biscale)
#install.packages("cowplot")
library(cowplot)
library(grid)
#install.packages("gridtext")
library(gridtext)
#install.packages("usmap")
library(usmap)
library(colorblindr)
```

```{r load-datasets}
mathlea_10 <- get_data("EDFacts_math_achievement_lea_2010_2019")

rlalea_10 <- get_data("EDFacts_rla_achievement_lea_2010_2019")

fiscal2010 <- get_data("NCES_CCD_fiscal_district_2010")

mathsch_10 <- get_data("EDFacts_math_achievement_sch_2010_2019")

rlasch_10 <- get_data("EDFacts_rla_achievement_sch_2010_2019")
```

### Data Visualization 1 
#### Rebecca
**Research Question:** 

How do high school students’ subgroup makeup (i.e., Race/ethnicity, Male vs. Female, economically disadvantaged, Limited English, Migrant status, Disability status, and Homelessness) differ among states/regions? 

**Datasets:** 

- EDFacts_math_achievement_sch_2010_2019
- EDFacts_rla_achievement_sch_2010_2019

```{r rebecca-datawrangling}

df <- full_join(mathsch_10, rlasch_10) 

df2 <- df %>% 
	mutate(ECDmath = gsub("[^0-9.-]", "", ECD_MTHHSPCTPROF),
				 ECDrla = gsub("[^0-9.-]", "", ECD_RLAHSPCTPROF),
				 LEPrla = gsub("[^0-9.-]", "", LEP_RLAHSPCTPROF),
				 LEPmath = gsub("[^0-9.-]", "", LEP_MTHHSPCTPROF),
				 HOMmath = gsub("[^0-9.-]", "", HOM_MTHHSPCTPROF),
				 HOMrla = gsub("[^0-9.-]", "", HOM_RLAHSPCTPROF),
				 Mmath = gsub("[^0-9.-]", "", M_MTHHSPCTPROF),
				 Mrla = gsub("[^0-9.-]", "", M_RLAHSPCTPROF),
				 Fmath = gsub("[^0-9.-]", "", F_MTHHSPCTPROF),
				 Frla = gsub("[^0-9.-]", "", F_RLAHSPCTPROF),
				 MBLmath = gsub("[^0-9.-]", "", MBL_MTHHSPCTPROF),
				 MBLrla = gsub("[^0-9.-]", "", MBL_RLAHSPCTPROF),
				 MHImath = gsub("[^0-9.-]", "", MHI_MTHHSPCTPROF),
				 MHIrla = gsub("[^0-9.-]", "", MHI_RLAHSPCTPROF),
				 MWHmath = gsub("[^0-9.-]", "", MWH_MTHHSPCTPROF),
				 MWHrla = gsub("[^0-9.-]", "", MWH_RLAHSPCTPROF),
				 CWDmath = gsub("[^0-9.-]", "", CWD_MTHHSPCTPROF),
				 CWDrla = gsub("[^0-9.-]", "", CWD_RLAHSPCTPROF))

df2$ECDmath = readr::parse_number(df2$ECDmath) 
df2$ECDrla = readr::parse_number(df2$ECDrla) 
df2$LEPrla = readr::parse_number(df2$LEPrla) 
df2$LEPmath = readr::parse_number(df2$LEPmath) 
df2$HOMrla = readr::parse_number(df2$HOMrla) 
df2$HOMmath = readr::parse_number(df2$HOMmath) 
df2$Mrla = readr::parse_number(df2$Mrla) 
df2$Mmath = readr::parse_number(df2$Mmath) 
df2$Frla = readr::parse_number(df2$Frla) 
df2$Fmath = readr::parse_number(df2$Fmath) 
df2$MBLrla = readr::parse_number(df2$MBLrla) 
df2$MBLmath = readr::parse_number(df2$MBLmath) 
df2$MHIrla = readr::parse_number(df2$MHIrla) 
df2$MHImath = readr::parse_number(df2$MHImath) 
df2$MWHmath = readr::parse_number(df2$MWHmath) 
df2$MWHrla = readr::parse_number(df2$MWHrla) 
df2$CWDmath = readr::parse_number(df2$CWDmath) 
df2$CWDrla = readr::parse_number(df2$CWDrla) 

dat <- df2 %>% 
	group_by(STNAM) %>% 
	summarise(
		mean_EconomicallyDisadvantaged_math = mean(ECDmath, na.rm = TRUE),
		mean_EconomicallyDisadvantaged_rla = mean(ECDrla, na.rm = TRUE),
		mean_EnglishLearner_math = mean(LEPmath, na.rm = TRUE),
		mean_EnglishLearner_rla = mean(LEPrla, na.rm = TRUE),
		mean_Homeless_math = mean(HOMmath, na.rm = TRUE),
		mean_Homeless_rla = mean(HOMrla, na.rm = TRUE),
		mean_Male_math = mean(Mmath, na.rm = TRUE),
		mean_Male_rla = mean(Mrla, na.rm = TRUE),
		mean_Female_math = mean(Fmath, na.rm = TRUE),
		mean_Female_rla = mean(Frla, na.rm = TRUE),
		mean_Black_math = mean(MBLmath, na.rm = TRUE),
		mean_Black_rla = mean(MBLrla, na.rm = TRUE),
		mean_Hispanic_math = mean(MHImath, na.rm = TRUE),
		mean_Hispanic_rla = mean(MHIrla, na.rm = TRUE),
		mean_White_math = mean(MWHmath, na.rm = TRUE),
		mean_White_rla = mean(MWHrla, na.rm = TRUE),
		mean_Disabled_math = mean(CWDmath, na.rm = TRUE),
		mean_Disabled_rla = mean(CWDrla, na.rm = TRUE)
	) 

dat <- dat %>% filter(!STNAM == "BUREAU OF INDIAN AFFAIRS" & !STNAM == "stnam" & !STNAM == "PUERTO RICO") 

regions <- import(here("data","us_census_bureau_regions_and_divisions.csv")) %>%
	rename(state = `State Code`, `STNAM` = State)

df_regions <- regex_inner_join(dat, regions,ignore_case = TRUE) 

df_pivot <- df_regions %>% 
	pivot_longer(
		cols = starts_with("mean_"),
		names_to = c("Subgroup", "test"),
		values_to = "mean_pct",
		names_sep = "_",
		values_drop_na = TRUE,
		names_repair = "check_unique",
		names_prefix = "mean_"
	) 

df_pivot$STNAM.y <- as.factor(df_pivot$STNAM.y)
df_pivot$Subgroup <- as.factor(df_pivot$Subgroup)

```

```{r rebecca-plots}
#Plot showing mean test score by subgroup and test

df_pivot %>%
	ggplot(aes(x = mean_pct,
						 y = fct_reorder(STNAM.y, mean_pct),
						 fill = mean_pct,
						 color = test)) +
	geom_point(size = .8,
						 alpha = .7) +
	facet_wrap(~Subgroup) +
	guides(fill = "none") +
	scale_color_discrete(l = 45,
											 name = "Test",
											 labels = c("Math", "Reading")) +
	labs(title = 'Mean percentage of students that scored at or above proficient',
			 x = 'Mean percent proficient',
			 y = 'State') +
	theme_minimal()

#This was a good first shot. I think you'll have to play with the fig.height and fig.width to see when it looks readable. Other than that, my personal preference would be to divide this into different sub-categories - for gender, for ability, for race and ethnicity, and so on. Or, if you don't want to do that then rearranging it in a different way.

#Plot showing mean test score by subgroup and test by state

df_pivot %>%   
	ggplot(aes(x = mean_pct, 
						 y = fct_reorder(Subgroup, mean_pct))) +
	geom_jitter(aes(color = test),
							size = .9,
							alpha = .8) +
	facet_wrap(~STNAM.y) +
	scale_color_discrete(l = 70,
											 name = "Test",
											 labels = c("Math", "Reading")) +
	labs(title = 'Mean percentage of students that scored at or above proficient',
			 x = 'Mean percent proficient',
			 y = 'Group') 

#Liked how you faceted by states

#Plot showing mean test score by subgroup and test by region

ggplot(df_pivot, aes(x = mean_pct, 
										 y = fct_reorder(Subgroup, mean_pct), 
										 fill = Region,
										 alpha = .7)) +
	guides(alpha = "none") +
	geom_density_ridges(rel_min_height = 0.005) +
	theme_minimal() +
	labs(title = 'Mean percentage of students that scored at or above proficient',
			 x = 'Mean percent proficient',
			 y = 'Group') 

#This was effective, maybe just rearranging the order

#Trying to figure out how to show test scores separated by Gender but the plot won't create separate values for each

df_pivot %>%
	filter(Subgroup %in% c("Male", "Female")) %>%
	group_by(Subgroup) %>%
	ggplot(aes(x = mean_pct,
						 y = fct_reorder(STNAM.y, mean_pct),
						 fill = stat(x))) +
	geom_density_ridges_gradient(scale = 2, size = 0.3, rel_min_height = 0.001) +
	scale_fill_viridis_c(name = "%", option = "C") +
	coord_cartesian(clip = "off") +
	theme_ridges(grid = FALSE) +
	labs(title = 'Mean percentage of students that scored at or above proficient by gender',
			 x = 'Mean percent proficient',
			 y = 'State')

#Liked this too, again play with the fig dimensions to see which one is more readable.

```

```{r rebecca-maps}
#Maps

us <- usa_sf()

us <- rename(us, state = iso_3166_2)

df_geo <- inner_join(df_pivot, us, by = "state")

dat2 <- full_join(df_pivot, df_geo)

#Math only
dat2 %>% 
	filter(test == "math") %>% 
	ggplot(aes(geometry = geometry, 
						 fill = mean_pct,
						 color = test), 
				 alpha = 0.9) + 
	facet_wrap(~Subgroup) +
	geom_sf(color = "white", size = 0) +
	guides(color = "none") +
	scale_fill_viridis(name = "%",
										 breaks = c(0, 20, 40, 60, 80)) +
	labs(title = "Mean percentage of students that scored at or above proficient",
			 subtitle = "Math",
			 caption = "Source: U.S. Department of Education") +
	theme_void()


#Reading only
dat2 %>% 
	filter(test == "rla") %>% 
	ggplot(aes(geometry = geometry, 
						 fill = mean_pct,
						 color = test), 
				 alpha = 0.9) + 
	facet_wrap(~Subgroup) +
	geom_sf(color = "white", size = 0) +
	guides(color = "none") +
	scale_fill_viridis(name = "%",
										 breaks = c(0, 20, 40, 60, 80)) +
	labs(title = "Mean percentage of students that scored at or above proficient",
			 subtitle = "Reading",
			 caption = "Source: U.S. Department of Education") +
	theme_void()

#combined map
ggplot(data = dat2, aes(geometry = geometry, 
												fill = mean_pct,
												color = test), 
			 alpha = 0.9) + 
	facet_wrap(~Subgroup) +
	geom_sf(color = "white", size = 0) +
	guides(color = "none") +
	scale_fill_viridis(name = "%",
										 breaks = c(0, 20, 40, 60, 80)) +
	labs(title = "Mean percentage of students that scored at or above proficient",
			 subtitle = "Across Math and Reading",
			 caption = "Source: U.S. Department of Education") +
	theme_void()

#These were all great! Nice palette, and effective visuals. I was confused what "white" patches meant - maybe they are missing data. Making a note of this as a caption will help.

```

### Data Visualization 2 

#### Ksenia

**Research Question:** 

What drives current expenditure on education? How is funding allocated by state and how do the funding allocations correlate with eh student performance (test scores)? Does cross-state variation in expenditure explain the cross-state variation in education outcomes? More specifically, I address the following questions:

-- What are the gross amounts of total expenditure and how do they vary by state?
- What amount of the total expenditure accounts for instruction, textbooks & special education? How do those allocations vary by state?
- Does increased spending on any of the categories correlate with increased students’ performance?  
- Can higher teachers’ salaries result in better test scores? (i.e. Does the spending on Instruction positively correlate with performance on standardized tests)
- What amount of funding is spent on special education and how that correlates with performance of students with disabilities? 
<!-- These are wonderful questions! -->


Not addressed at this point (yet?): 
- How do those percentages/ gross amounts correlate with the diversity of the student population/portion of white students in school?

**Datasets:**   

- EDFacts_rla_achievement_lea_2010_2019  
- EDFacts_math_achievement_lea_2010_2019  
- NCES_CCD_fiscal_district_2010

```{r ksenia-fiscaldata}
#skim(fiscal2010) #perhaps this shouldn't be printed

regions <- import(here("data", "us_census_bureau_regions_and_divisions.csv"), setclass = "tbl_df") %>% 
  rename(`STNAME` = State,
         STABBR = `State Code`) 

# Total spendings by state
total <-fiscal2010 %>% 
  group_by(STNAME) %>%
  summarise(TOTALEXP = sum(TOTALEXP),
            V33 = sum(V33)) 

total2 <- left_join(total, regions, by = "STNAME")

#Change scale of total spending
total2$TOTALEXP_B  <- total2$TOTALEXP/1000000000

#calculating the total spending per student
total2 <- total2 %>% 
  mutate(spend_per_stu = TOTALEXP/V33,
         spend_per_stu_k = (TOTALEXP/V33)/1000)

#spending on instruction by state 
instruction <- fiscal2010 %>%
  group_by(STNAME) %>%
      summarise(E13 = sum(E13), 
                V33 = sum(V33))

instruction2 <- left_join(instruction, regions, by = "STNAME")

#Change scale of total spending on instruction
instruction2$E13_B  <- instruction2$E13/1000000000

#calculating instruction spending per student
instruction2 <- instruction2 %>% 
  mutate(instr_per_stu = E13/V33,
         instr_per_stu_k = (E13/V33)/1000)

#spending on Special Ed teachers
SpEd <- fiscal2010 %>%
  group_by(STNAME) %>%
      summarise(Z36 = sum(Z36), 
                V33 = sum(V33))

SpEd2 <- left_join(SpEd, regions, by = "STNAME")

#removing the states with no data on Special Ed spending
SpEd2 <- SpEd2[SpEd2$Z36 >= 0, ]

#Change scale of total spending on SPecial Ed
SpEd2$Z36_B  <- SpEd2$Z36/1000000000

#spending on textbooks by state 
textbooks <- fiscal2010 %>%
  group_by(STNAME) %>%
      summarise(V93 = sum(V93),
                V33 = sum(V33))
textbooks2 <- left_join(textbooks, regions, by = "STNAME")

#removing the states with no data on textbook spending
textbooks2 <- textbooks2[textbooks2$V93 >= 0, ]

#Change scale of total spending on textbooks
textbooks2$V93_M  <- textbooks2$V93/1000000

#calculating textbook spending per student
textbooks2 <- textbooks2 %>% 
  mutate(book_per_stu = V93/V33)

```

```{r ksenia-testdata}
#getting reading and language arts data
rla <- rlalea_10 %>% 
  select(YEAR, 
         STNAM, 
         ALL_RLA00PCTPROF,
         MWH_RLA00PCTPROF,
         CWD_RLA00PCTPROF) %>% 
  rename(`STNAME` = STNAM) %>% 
  mutate(STNAME = str_to_title(STNAME), 
         (across(ALL_RLA00PCTPROF:CWD_RLA00PCTPROF, 
                 ~replace(., . %in% c("PS", 
                                      "n/a",	
                                      "LT50",	
                                      "LE5",	
                                      "LE20",	
                                      "LE10",	
                                      "GE99",	
                                      "GE95",	
                                      "GE90",	
                                      "GE80",	
                                      "GE50"), NA))))

#Mean rla scores for all students
rla <- rla %>% 
  tidyr::separate(ALL_RLA00PCTPROF, c("all_lower", "all_upper"), sep = "-") %>% 
  mutate(
    all_upper = ifelse(is.na(all_upper), all_lower, all_upper),
    all_lower = as.numeric(all_lower),
    all_upper = as.numeric(all_upper)
    ) %>% 
  rowwise() %>% 
  mutate(mean_rla_all = mean(c(all_lower, all_upper))) %>% 
  ungroup()

#Mean rla scores for white students
rla <- rla %>% 
  tidyr::separate(MWH_RLA00PCTPROF, c("wh_lower", "wh_upper"), sep = "-") %>% 
  mutate(
    wh_upper = ifelse(is.na(wh_upper), wh_lower, wh_upper),
    wh_lower = as.numeric(wh_lower),
    wh_upper = as.numeric(wh_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanf_rla_wh = mean(c(wh_lower, wh_upper))) %>% 
  ungroup()

# mean rla scores for students with disabilities
rla <- rla %>% 
  tidyr::separate(CWD_RLA00PCTPROF, c("dis_lower", "dis_upper"), sep = "-") %>% 
  mutate(
    dis_upper = ifelse(is.na(dis_upper), dis_lower, dis_upper),
    dis_lower = as.numeric(dis_lower),
    dis_upper = as.numeric(dis_upper)
    ) %>% 
  rowwise() %>% 
  mutate(mean_rla_dis = mean(c(dis_lower, dis_upper))) %>% 
  ungroup()

rla_new <- rla %>% 
  select(YEAR, 
         STNAME,
         contains("mean"))

#getting math data
math <- mathlea_10 %>% 
  select(YEAR, 
         STNAM, 
         ALL_MTH00PCTPROF,
         MWH_MTH00PCTPROF,
         CWD_MTH00PCTPROF) %>% 
  rename(`STNAME` = STNAM) %>%
  mutate(STNAME = str_to_title(STNAME), 
         (across(ALL_MTH00PCTPROF:CWD_MTH00PCTPROF, 
                 ~replace(., . %in% c("PS", 
                                      "n/a",	
                                      "LT50",	
                                      "LE5",	
                                      "LE20",	
                                      "LE10",	
                                      "GE99",	
                                      "GE95",	
                                      "GE90",	
                                      "GE80",	
                                      "GE50"), NA))))

#Mean math scores for all students
math <- math %>% 
  tidyr::separate(ALL_MTH00PCTPROF, c("all_lower", "all_upper"), sep = "-") %>% 
  mutate(
    all_upper = ifelse(is.na(all_upper), all_lower, all_upper),
    all_lower = as.numeric(all_lower),
    all_upper = as.numeric(all_upper)
    ) %>% 
  rowwise() %>% 
  mutate(mean_math_all = mean(c(all_lower, all_upper))) %>% 
  ungroup()

#Mean math scores for white students
math <- math %>% 
  tidyr::separate(MWH_MTH00PCTPROF, c("wh_lower", "wh_upper"), sep = "-") %>% 
  mutate(
    wh_upper = ifelse(is.na(wh_upper), wh_lower, wh_upper),
    wh_lower = as.numeric(wh_lower),
    wh_upper = as.numeric(wh_upper)
    ) %>% 
  rowwise() %>% 
  mutate(mean_math_wh = mean(c(wh_lower, wh_upper))) %>% 
  ungroup()

# mean mathscores for students with disabilities
math <- math %>% 
  tidyr::separate(CWD_MTH00PCTPROF, c("dis_lower", "dis_upper"), sep = "-") %>% 
  mutate(
    dis_upper = ifelse(is.na(dis_upper), dis_lower, dis_upper),
    dis_lower = as.numeric(dis_lower),
    dis_upper = as.numeric(dis_upper)
    ) %>% 
  rowwise() %>% 
  mutate(mean_math_dis = mean(c(dis_lower, dis_upper))) %>% 
  ungroup()

math_new <- math %>% 
  select(YEAR, 
         STNAME,
         contains("mean"))

scores <- full_join(math_new, 
                    rla_new, 
                              by = "STNAME")

#dataset with all the scores and the total spending on Education
scores_spending <- full_join(scores, 
                              total2,
                              by = "STNAME")

#dataset with all the scores and the total spending on Instruction
scores_instruction <- full_join(scores, 
                              instruction2,
                              by = "STNAME")

#dataset with all the scores and the total spending on Special Ed
scores_SpEd <- full_join(scores, 
                              SpEd2,
                              by = "STNAME")

#dataset with all the scores and the total spending on textbooks
scores_books <- full_join(scores, 
                              textbooks2,
                              by = "STNAME")

```

```{r ksenia-totalspending}
total2  %>%
  ggplot(aes(TOTALEXP_B, fct_reorder(STNAME, TOTALEXP_B))) +
  geom_col(aes(fill = Region),
           alpha = 0.9) +
  scale_fill_OkabeIto() + 
  scale_x_continuous(expand = c(0, 0), 
                     limits = c(0, 75),
                     breaks = c(0, 10, 20, 30, 40, 50, 60, 70), 
                     labels = c("0", "10 billion", "20 billion", "30 billion", "40 billion", "50 billion", "60 billion", "70 billion")) + 
  labs(title = "Total Spending on Education by State",
       y = "State",
       x = "Total Yearly Spending, in USD",
       caption = "Source: National Center for Education Statistics", 
       fill = "Region") + 
  geom_text(
    aes(TOTALEXP_B, STNAME, label = paste (round(TOTALEXP_B, 2), " B.")),
    nudge_x = 0.9,
    size = 2
  ) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) 

#An average spending by the region
total_rg_avg <- total2 %>% 
  group_by(Region) %>% 
  summarize(rg_avg = mean(TOTALEXP_B))

total_rg_avg  %>%
  ggplot(aes(rg_avg, fct_reorder(Region,rg_avg))) +
  geom_col(alpha = 0.9) +
  scale_fill_OkabeIto() + 
  scale_x_continuous(expand = c(0, 0), 
                     limits = c(0, 20),
                     breaks = c(0, 5, 10, 15), 
                     labels = c("0", "5 billion", "10 billion", "15 billion")) + 
  labs(title = "Average Total Spending on Education by Region",
       y = "Region",
       x = "Avergae Yearly Spending, in USD",
       caption = "Source: National Center for Education Statistics") + 
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) 


```
*TODO: format 'by region' plot if keeping it*

When looking at individual states, we can observe that California has the largest total spending on Education, followed by New York, and Texas. North Dakota and South Dakota yield the smallest total expensiture on education, with both states spending less $1.5B per year. The raw amounts of total spending don't give us a full picture, because states vary by population size and the number of students enrolled in high schools. Thus, it is beneficial to look at the expenditure per single student. 
```{r ksenia-total-perstudent} 
#plotting total spending per student by state
total2  %>%
  ggplot(aes(spend_per_stu_k, fct_reorder(STNAME, spend_per_stu_k))) +
  geom_col(aes(fill = Region),
           alpha = 0.9) +
  scale_fill_OkabeIto() + 
  scale_x_continuous(expand = c(0, 0), 
                     limits = c(0, 30),
                     breaks = c(0, 5, 10, 15, 20, 25), 
                     labels = c("0", "5K", "10K", "15K", "20K", "25K")) + 
  labs(title = "Total Spending on Education Per Single Student by State",
       y = "State",
       x = "Total Yearly Spending Per Student, in USD",
       caption = "Source: National Center for Education Statistics", 
       fill = "Region") + 
  geom_text(
    aes(spend_per_stu_k, STNAME, label = paste (round(spend_per_stu_k, 2), " K")),
    nudge_x = 0.45,
    size = 2) +
  geom_vline(aes(xintercept = mean(total2$spend_per_stu_k)), 
             data = total2, 
             linetype = 'dashed',
             size = 0.6,
             alpha = 1, 
             color = "gray60") +
  geom_label(data = total2, 
             aes(x = mean(total2$spend_per_stu_k)+1.6, 
                 y = 10,
                 label = "Avg. Spending
Per Student 
in the US = 
$ 12,977",
                 fill = NULL), 
                 color = "gray60",
                 size = 4,
                 fontface = "italic",
                 label.size = NA)  +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) 

#calculating an average spending per student by the region
total_rg_avg_stu <- total2 %>% 
  group_by(Region) %>% 
  summarize(rg_avg_stu = mean(spend_per_stu_k))

#plotting by region
total_rg_avg_stu  %>%
  ggplot(aes(rg_avg_stu, fct_reorder(Region,rg_avg_stu))) +
  geom_col(alpha = 0.9) +
  scale_fill_OkabeIto() + 
  scale_x_continuous(expand = c(0, 0), 
                     limits = c(0, 20),
                     breaks = c(0, 5, 10, 15), 
                     labels = c("0", "5K", "10K", "15K")) + 
  labs(title = "Average Total Spending on Education per Student by Region",
       y = "Region",
       x = "Avergae Yearly Spending per Student, in USD",
       caption = "Source: National Center for Education Statistics") + 
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) 
```
*TO_DO: format the 'by region' plot, if keeping it*
*TODO: figure out how to remove 'a's from the legend boxes*

District of Columbia spent the most total on a single student (\$25,613) in 2010, followed by New York (\$21,770) and Vermont (\$19,541). All Northeastern states are in the top 15 states with highest spending per student, which is reflected in the second plot demonstrating that in Northeastern states, an average spending per single students is the highest and equals \$17,194. 

The three states with the lowest spending per students are Idaho (\$7,798), Utah (\$8,040), and Arizona (\$8,999), which are all Western States. Compared to other regions, a Western state spends the least per student on average (\$11,745). It can be observed in the plot above that all Western states except Wyoming and Alaska spend less on a single student that the national mean. 

The observed patterns can also be vizualized in a map: 
```{r ksenia-total-map}
#Map visualization for the total spending per student by state
us2 <- usa_sf()
us2 <- rename(us2, STABBR = iso_3166_2)
total_map <- inner_join(total2, us2, by = "STABBR")

total_map %>% 
	ggplot(aes(geometry = geometry, 
						 fill = spend_per_stu_k,
						 color = "transparent"), 
				 alpha = 0.9) + 
	geom_sf(color = "white", size = 0.1) +
  guides(fill = guide_colorsteps(barwidth = 15,
                                 barheight = .5,
                                 title.position = "top",
                                 title.hjust = .5,
                                 title = "Total Sending\n[1000 US$ / Year]")) +
  scale_fill_viridis_c(option = "inferno",
                       breaks = c(0,5,10,15,20, 25, 30),
                       limits = c(0, 30),
                       begin = 0) +
	labs(title = "State total spendings on education per student",
			 subtitle = "2010",
			 caption = "Source: National Center for Education Statistics") +
  theme_void() + 
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = .08),
        plot.subtitle = element_text(hjust = .17))
```
```{r ksenia-instruction}
#Plotting the total Spending on Instruction by state
instruction2  %>%
  ggplot(aes(E13_B, fct_reorder(STNAME, E13_B))) +
  geom_col(aes(fill = Region),
           alpha = 0.9) +
  scale_fill_OkabeIto() + 
  scale_x_continuous(expand = c(0, 0), 
                     limits = c(0, 42),
                     breaks = c(0, 10, 20, 30, 40), 
                     labels = c("0", "10 billion", "20 billion", "30 billion", "40 billion")) + 
  labs(title = "Total Spending on Instruction by State",
       y = "State",
       x = "Total Yearly Spending, in USD",
       caption = "Source: National Center for Education Statistics", 
       fill = "Region") + 
  geom_text(
    aes(E13_B, STNAME, label = paste (round(E13_B, 2), " B.")),
    nudge_x = 0.85,
    size = 2
  ) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) 
```
```{r ksenia-instruction-perstudent}
#plotting spending on instruction per student by state 
instruction2  %>%
  ggplot(aes(instr_per_stu_k, fct_reorder(STNAME, instr_per_stu_k))) +
  geom_col(aes(fill = Region),
           alpha = 0.9) +
  scale_fill_OkabeIto() + 
  scale_x_continuous(expand = c(0, 0), 
                     limits = c(0, 20),
                     breaks = c(0, 5, 10, 15), 
                     labels = c("0", "5K", "10K", "15K")) + 
  labs(title = "Total Spending on Instruction Per Single Student by State",
       y = "State",
       x = "Total Yearly Spending on Instruction Per Student, in USD",
       caption = "Source: National Center for Education Statistics", 
       fill = "Region") + 
  geom_text(
    aes(instr_per_stu_k, STNAME, label = paste (round(instr_per_stu_k, 2), " K")),
    nudge_x = 0.45,
    size = 2) +
  geom_vline(aes(xintercept = mean(instruction2$instr_per_stu_k)), 
             data = instruction2, 
             linetype = 'dashed',
             size = 0.6,
             alpha = 1, 
             color = "gray60") +
  geom_label(data = instruction2, 
             aes(x = mean(instruction2$instr_per_stu_k)+1.1, 
                 y = 10,
                 label = "Avg. Spending
on Istruction
Per Student 
in the US = 
$ 6,531",
                 fill = NULL), 
                 color = "gray60",
                 size = 4,
                 fontface = "italic",
                 label.size = NA)  +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) 
```
*TODO: figure out how to remove 'a's from the legend boxes*

California, New York, and Texas are the leaders in the spending on instruction, which is to be expected given the states' population sizes. However, while California has the highest total spending on education, New York spends the most total on Instruction. South Dakota, North Dakota, and District of Columbia spend the least total on Instruction. 

When exploring the data for the spending on instruction per individual student, we see that New York spends the most (\$12,693). That exceeds the total instructional spending per student of the two runner-up states, New Jersey with \$9,706 and Vermont with \$9,555. Such a drastic increase in New York's spending can be correlated with the average teacher's salary in that state. All Northeastern state are in the top 15 highest spenders, as was the case with the total spending per student. Interestingly, District of Columbia that spent the most total per student in 2010, is only in the 9th place when it comes to instructional expenses only; DC reported \$8,194 in average instructional expenses per student. 
The observed patterns can also be vizualized in a map: 
```{r ksenia-instruction-map}
#Map visualization for the instructional spending per student by state
instr_map <- inner_join(instruction2, us2, by = "STABBR")

instr_map %>% 
	ggplot(aes(geometry = geometry, 
						 fill = instr_per_stu_k,
						 color = "transparent"), 
				 alpha = 0.9) + 
	geom_sf(color = "white", size = 0.1) +
  guides(fill = guide_colorsteps(barwidth = 15,
                                 barheight = .5,
                                 title.position = "top",
                                 title.hjust = .5,
                                 title = "Instructional Sending\n[1000 US$ / Year]")) +
  scale_fill_viridis_c(option = "inferno",
                       breaks = c(0, 3, 6, 9, 12, 15),
                       limits = c(0, 15),
                       begin = 0) +
	labs(title = "State instructional spendings per student",
			 subtitle = "2010",
			 caption = "Source: National Center for Education Statistics") +
  theme_void() + 
  theme(legend.position = "bottom",
        plot.title = element_text(hjust = .08),
        plot.subtitle = element_text(hjust = .17))
```
```{r ksenia-bivariate-total-RLA}
## biscale map
biscale <- 
  scores_spending %>% 
  group_by(STNAME) %>% 
  summarize(
    rla = mean(mean_rla_all, na.rm=TRUE),
    spend = mean(spend_per_stu_k, na.rm=TRUE)
  ) %>% 
  bi_class(x = rla, y = spend, style = "quantile", dim = 3)


names(biscale)[1]<-"full"
map_join<- biscale%>%left_join(statepop, by= "full") 


p2<-plot_usmap(data = map_join, values = "bi_class", labels = TRUE, label_color = "white")   +
  bi_scale_fill(pal = "DkCyan", dim = 3, guide = F) +
  scale_x_continuous(breaks = NULL) + 
  scale_y_continuous(breaks = NULL) +
  theme(
    plot.title = element_text(margin = margin(b = 8), 
                              color = "#ffffff",face = "bold",size = 9,
                              hjust = 0.5,
                              family = "Arial"),
    plot.subtitle = element_text(margin = margin(t=10,b = 25), 
                                 color = "#ffffff", size = 6, family = "Arial",
                                 hjust = 0.5),
    plot.caption =  element_text(margin = margin(t = 20), 
                                 color = "#ffffff", size = 5, family = "Arial",
                                 hjust = 0.95),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
    axis.text.x    = element_blank(),
    axis.text.y    = element_blank(),
    panel.background = element_blank(), 
    panel.grid.major = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(), 
    plot.background = element_rect(fill = "#f3f3f3", color = NA),
    panel.border = element_blank(),
    plot.margin = unit(c(1, 1, 1, 1), "cm"),
    axis.ticks = element_blank()
  ) 

legend_US<- 
  bi_legend(pal = "DkCyan",
            dim = 3,
            xlab = "Proficiency in RLA",
            ylab = "Spend total",
            size = 20) +
  theme(rect = element_rect(fill = "grey10"),
        panel.border = element_blank(),
        axis.text = element_blank(),
        plot.background = element_rect(fill = "#f3f3f3", color = NA),
        axis.title.x = element_text(size = 10,
                                    color = "#a1a1a1",
                                    face = "bold"),
        axis.title.y = element_text(size = 10,
                                    color = "#a1a1a1",
                                    face = "bold"),
        legend.text = element_text(size = 5),
        legend.text.align = 0)


ggdraw() +
  draw_plot(p2, 0, 0, 1, 1) +
  draw_plot(legend_US, 0, 0.1, 0.2, 0.2) +
  draw_label("Source:National Center for Education Statistics)", 
             color = "#a1a1a1", size = 7.5, angle = 0, x = 0.9, y = 0.05) +
  draw_label("In which states the total spending on Education per student positively affects the average performance in RLA?", 
             color = "#000000", size = 17, angle = 0, x =0.5, y = 0.97, fontface = "bold") +
  draw_label("Bivariate map shwoing the combination of the total spending on education per student and the average demonstrated proficiency in Reading and Langguage Arts", 
             color = "#000000", size = 14, angle = 0, x =0.5, y = 0.92) +
  theme(plot.background = element_rect(fill = "#f3f3f3", color = NA)) 
```
We can see that the increased total spending on a student person resulted in increased proficiency test scores in such states Illinois, Ohio, New York, Maryland, Connecticut, New Hampshire, and District of Columbia. Aligning with this trend are the states such as Arizona, Oklahoma, Missouri, Tennessee, Mississippi, and Florida, where the total spend on Education was the lowest relative to other states, and the students demonstrated the lowest scores in RLA. 
However, this trend is not categorical across all the states. States like Texas, Idaho, Utah, Colorado, and Georgia demonstrated relatively high RLA scores while they spend less per student. At the same time, Maine exhibits the opposite pattern: the high total spending on Education in those states negatively correlates with the students' RLA proficiency. 

*TODO: do the comaprison of total spendings for math scores*

Next, comparing math scores with spending on instruction only 
```{r ksenia-bivariate-intruction-math}
biscale2 <- 
  scores_instruction %>% 
  group_by(STNAME) %>% 
  summarize(
    math = mean(mean_math_all, na.rm=TRUE),
    instr = mean(instr_per_stu_k, na.rm=TRUE)
  ) %>% 
  bi_class(x = math, y = instr, style = "quantile", dim = 3)


names(biscale2)[1]<-"full"
map_join2<- biscale2%>%left_join(statepop, by= "full") 


p3<-plot_usmap(data = map_join2, values = "bi_class", labels = TRUE, label_color = "white")   +
  bi_scale_fill(pal = "DkCyan", dim = 3, guide = F) +
  scale_x_continuous(breaks = NULL) + 
  scale_y_continuous(breaks = NULL) +
  theme(
    plot.title = element_text(margin = margin(b = 8), 
                              color = "#ffffff",face = "bold",size = 9,
                              hjust = 0.5,
                              family = "Arial"),
    plot.subtitle = element_text(margin = margin(t=10,b = 25), 
                                 color = "#ffffff", size = 6, family = "Arial",
                                 hjust = 0.5),
    plot.caption =  element_text(margin = margin(t = 20), 
                                 color = "#ffffff", size = 5, family = "Arial",
                                 hjust = 0.95),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
    axis.text.x    = element_blank(),
    axis.text.y    = element_blank(),
    panel.background = element_blank(), 
    panel.grid.major = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(), 
    plot.background = element_rect(fill = "#f3f3f3", color = NA),
    panel.border = element_blank(),
    plot.margin = unit(c(1, 1, 1, 1), "cm"),
    axis.ticks = element_blank()
  ) 

legend_US3<- 
  bi_legend(pal = "DkCyan",
            dim = 3,
            xlab = "Proficiency in Math",
            ylab = "Instructional Spend",
            size = 20) +
  theme(rect = element_rect(fill = "grey10"),
        panel.border = element_blank(),
        axis.text = element_blank(),
        plot.background = element_rect(fill = "#f3f3f3", color = NA),
        axis.title.x = element_text(size = 10,
                                    color = "#a1a1a1",
                                    face = "bold"),
        axis.title.y = element_text(size = 10,
                                    color = "#a1a1a1",
                                    face = "bold"),
        legend.text = element_text(size = 5),
        legend.text.align = 0)


ggdraw() +
  draw_plot(p3, 0, 0, 1, 1) +
  draw_plot(legend_US3, 0, 0.1, 0.2, 0.2) +
  draw_label("Source:National Center for Education Statistics)", 
             color = "#a1a1a1", size = 7.5, angle = 0, x = 0.9, y = 0.05) +
  draw_label("In which states the total spending on Instruction per student positively affects performance in Math?", 
             color = "#000000", size = 17, angle = 0, x =0.5, y = 0.97, fontface = "bold") +
  draw_label("Bivariate map shwoing the combination of the total spending on intrusction per student and the average demonstrated proficiency in Math", 
             color = "#000000", size = 14, angle = 0, x =0.5, y = 0.92) +
  theme(plot.background = element_rect(fill = "#f3f3f3", color = NA)) 
```
*TODO: do somth with Wyoming and Alabama (no data for them) *

We can observe the general tendency of positive correlation between Expenditure on Instruction and MAth proficiency. In Nebraska, New York, Pennsylvania, Maryland, District of Columbia, and Connecticut, increased spending on instruction results in increased math scores. In Oregon, Montana, Michigan, Indiana, and Ohia, the avergae spending on instruction matches the average math scores. Arizona, Oklahoma, New Mexico, Tennessee, Mississippi, report the lowest total spend on Instruction, which correlates with the relatively low demonstrated proficiency in math by students of those states . 
Interestingly, Texas and Idaho that demonstrated the high RLA scores despite small total spending, exhibit the same pattern here: hogh math scores despite low spending on Instruction. Other states that show the same pattern with instructional spending are Colorado, South Dakota, and North Carolina. On the flip side, Maine again exhibits the opposite pattern: the high instructional spending negatively correlates with the students' math proficiency. Here, the same trend is observed in Minnesota and Hawaii. 

*TODO: do the comaprison of instruction spendings for rla scores*

```{r ksenia-SpEd}
#Plotting the total Spending on SPecial Ed by state
SpEd2  %>%
  ggplot(aes(Z36_B, fct_reorder(STNAME, Z36_B))) +
  geom_col(aes(fill = Region),
           alpha = 0.9) +
  scale_fill_OkabeIto() + 
  scale_x_continuous(expand = c(0, 0), 
                     limits = c(0, 4),
                     breaks = c(0, 0.5, 1, 1.5, 2, 2.5, 3, 3.5), 
                     labels = c("0", "500 million", "1 billion", "1.5 billion", "2 billion", "2.5 billion", "3 billion", "3.5 billion"))+ 
  labs(title = "Total Spending on Special Ed Teachers by State",
       y = "State",
       x = "Total Yearly Spending on Special Ed, in USD",
       caption = "Source: National Center for Education Statistics", 
       fill = "Region") + 
  geom_text(
    aes(Z36_B, STNAME, label = paste (round(Z36_B, 2), " B.")),
    nudge_x = 0.1,
    size = 3
  ) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) 
```
```{r ksenia-SpEd-bivariate}
biscale4 <- 
  scores_SpEd %>% 
  group_by(STNAME) %>% 
  summarize(
    math = mean(mean_math_dis, na.rm=TRUE),
    SpEd = mean(Z36, na.rm=TRUE)
  ) %>% 
  bi_class(x = math, y = SpEd, style = "quantile", dim = 3)


names(biscale4)[1]<-"full"
map_join4<- biscale4%>%left_join(statepop, by= "full") 


p4<-plot_usmap(data = map_join4, values = "bi_class", labels = TRUE, label_color = "white")   +
  bi_scale_fill(pal = "DkCyan", dim = 3, guide = F) +
  scale_x_continuous(breaks = NULL) + 
  scale_y_continuous(breaks = NULL) +
  theme(
    plot.title = element_text(margin = margin(b = 8), 
                              color = "#ffffff",face = "bold",size = 9,
                              hjust = 0.5,
                              family = "Arial"),
    plot.subtitle = element_text(margin = margin(t=10,b = 25), 
                                 color = "#ffffff", size = 6, family = "Arial",
                                 hjust = 0.5),
    plot.caption =  element_text(margin = margin(t = 20), 
                                 color = "#ffffff", size = 5, family = "Arial",
                                 hjust = 0.95),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.title = element_blank(),
    axis.text.x    = element_blank(),
    axis.text.y    = element_blank(),
    panel.background = element_blank(), 
    panel.grid.major = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.minor = element_blank(), 
    plot.background = element_rect(fill = "#f3f3f3", color = NA),
    panel.border = element_blank(),
    plot.margin = unit(c(1, 1, 1, 1), "cm"),
    axis.ticks = element_blank()
  ) 

legend_US4<- 
  bi_legend(pal = "DkCyan",
            dim = 3,
            xlab = "Proficiency in Math",
            ylab = "Special Ed Spend",
            size = 20) +
  theme(rect = element_rect(fill = "grey10"),
        panel.border = element_blank(),
        axis.text = element_blank(),
        plot.background = element_rect(fill = "#f3f3f3", color = NA),
        axis.title.x = element_text(size = 10,
                                    color = "#a1a1a1",
                                    face = "bold"),
        axis.title.y = element_text(size = 10,
                                    color = "#a1a1a1",
                                    face = "bold"),
        legend.text = element_text(size = 5),
        legend.text.align = 0)


ggdraw() +
  draw_plot(p4, 0, 0, 1, 1) +
  draw_plot(legend_US4, 0, 0.1, 0.2, 0.2) +
  draw_label("Source:National Center for Education Statistics)", 
             color = "#a1a1a1", size = 7.5, angle = 0, x = 0.9, y = 0.05) +
  draw_label("In which states the total spending on Special Edcuation positively affects performance of children with disabilities in Math?", 
             color = "#000000", size = 14, angle = 0, x =0.5, y = 0.97, fontface = "bold") +
  draw_label("Bivariate map showing the combination of the total spending on Special Education and the average demonstrated proficiency in Math of children with disabilities", 
             color = "#000000", size = 12, angle = 0, x =0.5, y = 0.92) +
  theme(plot.background = element_rect(fill = "#f3f3f3", color = NA)) 
```
Generally, all the states that spend the most on special education report the highest permormance results on math tests. 

*TODO: deal with the states that have no data*
*TODO: besides bivariate maps, include scatterplots to show all the correlations*
```{r ksenia-textbooks-total}
#Plot of Total Spending on Textbooks by state
textbooks2  %>%
  ggplot(aes(V93_M, fct_reorder(STNAME, V93_M))) +
  geom_col(aes(fill = Region),
           alpha = 0.9) +
  scale_fill_OkabeIto() + 
  scale_x_continuous(expand = c(0, 0), 
                     limits = c(0, 350),
                     breaks = c(0, 50, 100, 150, 200, 250, 300, 350), 
                     labels = c("0", "50 million", "100 million", "150 million", "200 million", "250 million", "300 million", "350 million")) + 
  labs(title = "Total Spending on Textbook by State",
       y = "State",
       x = "Total Textbook Spending, in USD",
       caption = "Source: National Center for Education Statistics", 
       fill = "Region") + 
  geom_text(
    aes(V93_M, STNAME, label = paste (round(V93_M, 2), " M.")),
    nudge_x = 8,
    size = 2
  ) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) 
```
```{r ksenia-textbooks-bystudent}
#plotting spending on textbooks per student by state 
textbooks2  %>%
  ggplot(aes(book_per_stu, fct_reorder(STNAME, book_per_stu))) +
  geom_col(aes(fill = Region),
           alpha = 0.9) +
  scale_fill_OkabeIto() + 
  scale_x_continuous(expand = c(0, 0), 
                     limits = c(0, 150),
                     breaks = c(0, 25, 50, 75, 100, 125, 150))+ 
                    # labels = c("0", "5K", "10K", "15K")) + 
  labs(title = "Total Spending on Textbooks Per Single Student by State",
       y = "State",
       x = "Total Yearly Spending on Textbooks Per Student, in USD",
       caption = "Source: National Center for Education Statistics", 
       fill = "Region") + 
  geom_text(
    aes(book_per_stu, STNAME, label = round(book_per_stu, 2)),
    nudge_x = 2.2,
    size = 3) +
  geom_vline(aes(xintercept = mean(textbooks2$book_per_stu)), 
             data = instruction2, 
             linetype = 'dashed',
             size = 0.6,
             alpha = 1, 
             color = "gray60") +
  geom_label(data = instruction2, 
             aes(x = mean(textbooks2$book_per_stu)+8, 
                 y = 10,
                 label = "Avg. Spending
on Textbooks
Per Student 
in the US = 
$ 60.01",
                 fill = NULL), 
                 color = "gray60",
                 size = 4,
                 fontface = "italic",
                 label.size = NA)  +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) 

#These were all great visuals! 
#I think your final maps have nice color palette. The correlation is hard to understand on a map though. I had to remind myself of how the color grid is arranged, and think it's somewhat cognitively challenging to interpret.  
```

### Data Visualization 3 
#### Amy
**Research Question:** 

What is the relationship between the local revenue of local education agencies and students’ literacy outcomes on statewide assessments in 2010? Additional areas of exploration included (a) average total local revenue and local revenue property taxes by state, (b) the relationship between outcomes and total local revenue vs. local revenue from property taxes, (c) the relationship between both types of funding and outcomes by state, and (d) relationship between both types of revenue and outcomes of student subgroups (e.g., race/ethnicity, disability status, language proficiency, SES). 

**Datasets:**  

- EDFacts_rla_achievement_lea_2010_2019  
- NCES_CCD_fiscal_district_2010 

**Variables:**

EDFacts_rla_achievement_lea_2010_2019

- YEAR
- STNAM
- FIPST
- LEAID
- ALL_RLA00PCTPROF = Percentage of all students who scored at or above their state's proficiency level on Reading/Language Arts.
- MAM_RLA03PCTPROF = Percentage of Native American students that scored at or above proficient
- MAS_RLA00PCTPROF = Percentage of Asian/Pacific Islander students that scored at or above proficient
- MBL_RLA00PCTPROF = Percentage of Black students that scored at or above proficient
- MHI_RLA00PCTPROF = Percentage of Hispanic students that scored at or above proficient
- MTR_RLA00PCTPROF = Percentage of students with Two or More Races that scored at or above proficient
- MWH_RLA03PCTPROF = Percentage of White students that scored at or above proficient
- CWD_RLA00PCTPROF = Percentage of children with disabilities that scored at or above proficient
- ECD_RLA00PCTPROF = Percentage of economically disadvantaged students that scored at or above proficient
- LEP_RLA00PCTPROF = Percentage of limited English proficient students that scored at or above proficient

NCES_CCD_fiscal_district_2010:

- NAME 
- STABBR
- CENSUSID
- V33 = LEA fall membership (i.e., number of students) 
- TOTALREV = LEA total revenue
- TFEDREV = LEA total federal revenue
- TSTREV = LEA total state revenue
- TLOCREV = LEA total local revenue 
- T06 = LEA local revenue from property taxes

**Cleaning and Wrangling**

```{r amy-viz3-cleaning-fiscal}
# Selected columns of interest. Filtered so that rows with suppressed values (e.g., -9, -2) for key variables of interest weren't included. 
viz3_fiscal2010 <- fiscal2010 %>% 
  select(LEAID, NAME, STABBR, CENSUSID, V33,
         TOTALREV, TFEDREV, TSTREV, TLOCREV, T06) %>% 
  filter(V33 > 0, TLOCREV > 0, T06 > 0) %>%
  rename_with(tolower) %>% 
  rename(totalstu = v33, tlocrevtaxes = t06) %>% 
  mutate(locrev_stu = tlocrev / totalstu,
         locrevtaxes_stu = tlocrevtaxes / totalstu)
```

```{r amy-viz3-rla-allgrades-cleaning-wrangling}
# Narrowed the RLA 2010 file down to variables of interest. Selected percent proficient variables across all grades (00) for race ethnicity, disability, English Language Learner status, and economically disadvantaged subgroups. Transformed variable names to be lowercase, transformed state names to be title case, and replaced the suppressed values (e.g., PS, n/a, etc.) with NA.
viz3_rlalea00 <- rlalea_10 %>% 
  select(YEAR, 
         STNAM, 
         FIPST,
         LEAID, 
         ALL_RLA00PCTPROF, 
         MAM_RLA00PCTPROF,
         MAS_RLA00PCTPROF,
         MBL_RLA00PCTPROF,
         MHI_RLA00PCTPROF,
         MTR_RLA00PCTPROF, 
         MWH_RLA00PCTPROF,
         CWD_RLA00PCTPROF,
         ECD_RLA00PCTPROF,
         LEP_RLA00PCTPROF) %>% 
  rename_with(tolower)  %>% 
  mutate(stnam = str_to_title(stnam), 
         (across(all_rla00pctprof:lep_rla00pctprof, 
                 ~replace(., . %in% c("PS", 
                                      "n/a",	
                                      "LT50",	
                                      "LE5",	
                                      "LE20",	
                                      "LE10",	
                                      "GE99",	
                                      "GE95",	
                                      "GE90",	
                                      "GE80",	
                                      "GE50"), NA))))

# Next step was cleaning the percentage columns to change percentage ranges to average percentages. I used the method Daniel used on the course data webpage and applied it to all subgroups.

# All = across all students
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(all_rla00pctprof, c("all_lower", "all_upper"), sep = "-") %>% 
  mutate(
    all_upper = ifelse(is.na(all_upper), all_lower, all_upper),
    all_lower = as.numeric(all_lower),
    all_upper = as.numeric(all_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_all = mean(c(all_lower, all_upper))) %>% 
  ungroup()

# mam = American Indian/Alaska Native
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(mam_rla00pctprof, c("mam_lower", "mam_upper"), sep = "-") %>% 
  mutate(
    mam_upper = ifelse(is.na(mam_upper), mam_lower, mam_upper),
    mam_lower = as.numeric(mam_lower),
    mam_upper = as.numeric(mam_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_mam = mean(c(mam_lower, mam_upper))) %>% 
  ungroup()

# mas = Asian/Pacific Islander
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(mas_rla00pctprof, c("mas_lower", "mas_upper"), sep = "-") %>% 
  mutate(
    mas_upper = ifelse(is.na(mas_upper), mas_lower, mas_upper),
    mas_lower = as.numeric(mas_lower),
    mas_upper = as.numeric(mas_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_mas = mean(c(mas_lower, mas_upper))) %>% 
  ungroup()

# mbl = Black
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(mbl_rla00pctprof, c("mbl_lower", "mbl_upper"), sep = "-") %>% 
  mutate(
    mbl_upper = ifelse(is.na(mbl_upper), mbl_lower, mbl_upper),
    mbl_lower = as.numeric(mbl_lower),
    mbl_upper = as.numeric(mbl_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_mbl = mean(c(mbl_lower, mbl_upper))) %>% 
  ungroup()

# mhi = Hispanic/Latino
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(mhi_rla00pctprof, c("mhi_lower", "mhi_upper"), sep = "-") %>% 
  mutate(
    mhi_upper = ifelse(is.na(mhi_upper), mhi_lower, mhi_upper),
    mhi_lower = as.numeric(mhi_lower),
    mhi_upper = as.numeric(mhi_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_mhi = mean(c(mhi_lower, mhi_upper))) %>% 
  ungroup()

# mtr = Multiracial
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(mtr_rla00pctprof, c("mtr_lower", "mtr_upper"), sep = "-") %>% 
  mutate(
    mtr_upper = ifelse(is.na(mtr_upper), mtr_lower, mtr_upper),
    mtr_lower = as.numeric(mtr_lower),
    mtr_upper = as.numeric(mtr_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_mtr = mean(c(mtr_lower, mtr_upper))) %>% 
  ungroup()

# mwh = White
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(mwh_rla00pctprof, c("mwh_lower", "mwh_upper"), sep = "-") %>% 
  mutate(
    mwh_upper = ifelse(is.na(mwh_upper), mwh_lower, mwh_upper),
    mwh_lower = as.numeric(mwh_lower),
    mwh_upper = as.numeric(mwh_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_mwh = mean(c(mwh_lower, mwh_upper))) %>% 
  ungroup()

# cwd = children with disabilities
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(cwd_rla00pctprof, c("cwd_lower", "cwd_upper"), sep = "-") %>% 
  mutate(
    cwd_upper = ifelse(is.na(cwd_upper), cwd_lower, cwd_upper),
    cwd_lower = as.numeric(cwd_lower),
    cwd_upper = as.numeric(cwd_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_cwd = mean(c(cwd_lower, cwd_upper))) %>% 
  ungroup()

# ecd = economically disadvantaged
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(ecd_rla00pctprof, c("ecd_lower", "ecd_upper"), sep = "-") %>% 
  mutate(
    ecd_upper = ifelse(is.na(ecd_upper), ecd_lower, ecd_upper),
    ecd_lower = as.numeric(ecd_lower),
    ecd_upper = as.numeric(ecd_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_ecd = mean(c(ecd_lower, ecd_upper))) %>% 
  ungroup()

# lep = limited English proficiency (English Language Learner)
viz3_rlalea00 <- viz3_rlalea00 %>% 
  tidyr::separate(lep_rla00pctprof, c("lep_lower", "lep_upper"), sep = "-") %>% 
  mutate(
    lep_upper = ifelse(is.na(lep_upper), lep_lower, lep_upper),
    lep_lower = as.numeric(lep_lower),
    lep_upper = as.numeric(lep_upper)
    ) %>% 
  rowwise() %>% 
  mutate(meanpctprof_lep = mean(c(lep_lower, lep_upper))) %>% 
  ungroup()

# Get ride of the "_lower" and "_upper" percentage columns since they won't be needed
viz3_rlalea00 <- viz3_rlalea00 %>% 
  select(year, 
         stnam, 
         fipst,
         leaid,
         contains("meanpctprof"))
```

```{r amy-viz3-rla-allgrades-pivotlonger}
# Pivoted the dataset longer to have a column for subgroup and a column for mean percentage proficient. 

viz3_rlalea00_long <- viz3_rlalea00 %>%
  pivot_longer(
 		cols = contains("meanpctprof"),
 		names_to = "subgroup",
 		values_to = "meanpctprof",
 		names_prefix = "meanpctprof_") 
```

```{r amy-viz3-rla-allgrades-join}
# Joined the long file with the cleaned/narrowed fiscal data file. Used an inner join because I'm only interested in LEAs that have both student proficiency and fiscal data. 
viz3_rla00long_fiscal_2010 <- inner_join(viz3_rlalea00_long, 
                                         viz3_fiscal2010, 
                                         by = "leaid")
```

**Potential Visualizations**

These are the data visualizations I am thinking I will choose from for our final product. I'm not going to include all of these. My primary next step is to narrow them down. Please note that they are still a bit rough and need refinement (some more than others). Refinement plans include... finalizing color, trying out annotations and/or highlighting, and exploring alternate options for faceting by state. If I include the plots with fitted lines, I plan to update the colors and replace the legend with annotations.

First off, bar graphs. The first two summarize LEA local revenue and LEA local revenue from property taxes averaged by state. The third graph summarizes the average percentage of students scoring at/above proficient by state. 

```{r amy-viz3-bargraphs, fig.height=7}
# Bar graph: Average LEA total local revenue ($ per student) by state
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all")  %>% 
  group_by(stnam) %>% 
  summarize(mean_locrev_stu = mean(locrev_stu)) %>% 
  ggplot(aes(x = mean_locrev_stu, y = fct_reorder(stnam, mean_locrev_stu))) +
  geom_col(color = "white", alpha = .6) +
  scale_x_continuous(expand = c(0, 0),
                     breaks = c(0, 2500, 5000, 7500, 10000, 12500),
                     labels = scales::dollar) +
  labs(title = "Average Local Revenue of LEAs",
       y = "State",
       x = "Dollar per student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())  

# Bar graph: Average LEA local revenue from property taxes ($ per student) by state
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all")  %>% 
  group_by(stnam) %>% 
  summarize(mean_locrevtaxes_stu = mean(locrevtaxes_stu)) %>% 
  ggplot(aes(x = mean_locrevtaxes_stu, 
             y = fct_reorder(stnam, mean_locrevtaxes_stu))) +
  geom_col(color = "white", alpha = .6) +
  scale_x_continuous(expand = c(0, 0),
                    breaks = c(0, 2500, 5000, 7500, 10000),
                     labels = scales::dollar) +
  labs(title = "Average Local Revenue of LEAs from Property Taxes",
       y = "State",
       x = "Dollar per student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())

# Bar graph of average RLA proficiency for each state
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all")  %>% 
  group_by(stnam) %>% 
  summarize(mean_pctprof = mean(meanpctprof, na.rm = T)) %>% 
  ggplot(aes(x = mean_pctprof, y = fct_reorder(stnam, mean_pctprof))) +
  geom_col(color = "white", alpha = .6) +
  scale_x_continuous(expand = c(0, 0),
                    breaks = c(0, 20, 40, 60, 80),
                    labels = c("0%", "20%", "40%", "60%", "80%")) +
  labs(title = "Average Proficiency in Reading/Language Arts",
       subtitle = "Students in Grades 3 through HS",
       y = "State",
       x = "Average Percentage",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())  

#Great, maybe change the bar colors
```

Density ridges of local revenue from property taxes for LEAs by state. One thing I plan to do, if I include this plot, that I didn't get to is sorting the states by mean revenue.

```{r amy-viz3-densityridges, fig.height=7}
# Density ridges of local revenue from property taxes across LEAs by state
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all")  %>% 
  ggplot(aes(x = locrevtaxes_stu, y = stnam)) +
 	geom_density_ridges(fill = "cornflower blue", color = "white", alpha = .8) +
 	theme_minimal() +
  labs(title = "Local Revenue from Property Taxes in LEAS of Each State",
       y = "State",
       x = "Dollar per student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot") + 
  scale_x_continuous(expand = c(0, 0)) +
  coord_cartesian(xlim = c(0, 25000))
```

Scatterplots showing the relationship between types of revenue and average percentage of students scoring at/above proficient on statewide assessments of reading/language arts. Note that I used a log transformation of the x-axis to spread the points out. Without the transformation, the bulk of the points were clustered near the bottom of the range. I think that I could use highlighting and annotations for the lowest and highest points.

```{r amy-viz3-scatterplots1, fig.width=7, fig.height=7}
# Scatterplots: All students, LEA total local revenue ($ per stu) and LEA local revenue from property taxes by approx. pct proficient
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  geom_point(color = "gray30", fill = "gray30", alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Relationship between Local Revenue and RLA Proficiency",
       y = "Approximate Average Percent Proficient",
       x = "Dollar per Student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) 

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all") %>% 
  ggplot(aes(x = locrevtaxes_stu, y = meanpctprof)) +
  geom_point(color = "gray30", fill = "gray30", alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Local Revenue from Property Taxes and RLA Proficiency",
       y = "Approximate Average Percent Proficient",
       x = "Dollar per Student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())
```

Scatterplots faceted by state. 

```{r amy-viz3-scatterplots2, fig.height=10, fig.width=12}
# Scatterplot: All students - relationship between local revenue ($ per student) and mean % proficient, faceted by state
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(color = "gray30", fill = "gray30", alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Total Local Revenue and RLA Proficiency",
       y = "Approximate Average Percent Proficient",
       x = "Dollar per Student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) 

# Scatterplot: All students - relationship between local revenue from property taxes ($ per student) and mean % proficient, faceted by state
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all") %>% 
  ggplot(aes(x = locrevtaxes_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(color = "gray30", fill = "gray30", alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Local Revenue from Property Taxes and RLA Proficiency",
       y = "Approximate Average Percent Proficient",
       x = "Dollar per Student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())
```

Scatterplots showing the relationship between revenue and outcomes, faceted by subgroup. These are still pretty rough (e.g., labels need work).

```{r amy-viz3-scatterplots3, fig.height=10, fig.width=10}
# Scatterplot: Relationship between local revenue ($ per student) and mean % proficient, faceted by subgroup
viz3_rla00long_fiscal_2010 %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~subgroup) +
  geom_point(color = "gray30", fill = "gray30", alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Total Local Revenue and RLA Proficiency",
       y = "Approximate Average Percent Proficient",
       x = "Dollar per Student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) 

# Scatterplot: Relationship between local revenue from property taxes ($ per student) and mean % proficient, faceted by subgroup
viz3_rla00long_fiscal_2010 %>% 
  ggplot(aes(x = locrevtaxes_stu, y = meanpctprof)) +
  facet_wrap(~subgroup) +
  geom_point(color = "gray30", fill = "gray30", alpha = .4) +
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Local Revenue from Property Taxes and RLA Proficiency",
       y = "Approximate Average Percent Proficient",
       x = "Dollar per Student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())
```

Playing around with fitting lines. These are still rough. I need to work on the legend and want to try replacing it with annotations. Also could consider changing the color to highlight a specific group or pick a different color palette. 

```{r amy-viz3-fittedlines}
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup != "all") %>% 
  ggplot() +
  geom_smooth(method = lm, 
              se = F, 
              aes(x = locrevtaxes_stu, 
                  y = meanpctprof, 
                  color = subgroup)) +
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Local Revenue from Property Taxes and RLA Proficiency",
       y = "Approximate Average Percent Proficient",
       x = "Dollar per Student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())
```

Fitted lines faceted by state (also very rough).

```{r amy-viz3-fittedlines2, fig.height=10, fig.width=12}
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup != "all") %>% 
  ggplot() +
  geom_smooth(method = lm, se = F, aes(x = locrevtaxes_stu, y = meanpctprof, color = subgroup)) +
  facet_wrap(~stnam) +
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Local Revenue from Property Taxes and RLA Proficiency",
       y = "Approximate Average Percent Proficient",
       x = "Dollar per Student",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())
```

Created maps displaying (a) average LEA local revenue in each state and (b) average LEA local revenue from property taxes in each state. I still need to fill in the missing states and want to try out different color palettes.  

```{r amy-viz3-map}
viz3_map_dfprep <- viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all") %>% 
  group_by(stnam) %>% 
  summarize(mean_locrev_stu = mean(locrev_stu),
            mean_locrevtaxes_stu = mean(locrevtaxes_stu))

viz3_us <- usa_sf() 

viz3_map_df <- left_join(viz3_map_dfprep, 
                      viz3_us, 
                      by = c("stnam" = "name"))

viz3_map_df %>% 
  ggplot(aes(geometry = geometry, fill = mean_locrev_stu)) +
  geom_sf(color = "white", size = 0) +
 	scale_fill_viridis(option = "magma", 
 	                   name = "Dollar per student",
 										 breaks = c(0, 2500, 5000, 7500, 10000, 12500),
 										 labels = c("$0", 
 										            "$2,500", 
 										            "$5,000", 
 										            "$7,500", 
 										            "$10,000",
 										            "$12,500")) +
  theme_void() +
  labs(title = "Average LEA Total Local Revenue",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme(plot.title.position = "plot") 


viz3_map_df %>% 
  ggplot(aes(geometry = geometry, fill = mean_locrevtaxes_stu)) +
  geom_sf(color = "white", size = 0) +
 	scale_fill_viridis(option = "magma", 
 	                   name = "Dollar per student",
 										 breaks = c(0, 2500, 5000, 7500, 10000),
 										 labels = c("$0", 
 										            "$2,500", 
 										            "$5,000", 
 										            "$7,500", 
 										            "$10,000")) +
  theme_void() +
  labs(title = "Average LEA Local Revenue from Property Taxes",
       caption = "Source: National Center for Education Statistics, 2010") +
  theme(plot.title.position = "plot") 
```

**Other Data Visualizations**

These are some of the preliminary visualizations I did that I don't think I'm moving forward with. Because of this, refinement is minimal. 

```{r amy-viz3-prelim1}
# Scatterplot: Total local LEA revenue from property taxes ($ per stu) x approx. pct proficient, color = subgroup
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup != "all") %>% 
  ggplot(aes(x = locrevtaxes_stu, y = meanpctprof, color = subgroup)) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  theme_minimal() +
  labs(title = "Revenue from property tax x meanpctprof, color by subgroup") +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())
```

Fitted lines for specific states:
```{r amy-viz3-prelim2}
# fitted lines in a few specific states
viz3_rla00long_fiscal_2010 %>% 
  filter(stnam == "Montana") %>% 
  ggplot() +
  geom_smooth(method = lm, 
              se = F, 
              aes(x = locrevtaxes_stu, 
                  y = meanpctprof, 
                  color = subgroup)) +
  scale_x_log10(labels = scales::dollar) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())  +
  labs(title = "Montana")

viz3_rla00long_fiscal_2010 %>% 
  filter(stnam == "South Dakota") %>% 
  ggplot() +
  geom_smooth(method = lm, 
              se = F, 
              aes(x = locrevtaxes_stu, 
                  y = meanpctprof, 
                  color = subgroup)) +
  scale_x_log10(labels = scales::dollar) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) +
  labs(title = "South Dakota")

viz3_rla00long_fiscal_2010 %>% 
  filter(stnam == "New Jersey") %>% 
  ggplot() +
  geom_smooth(method = lm, 
              se = F, 
              aes(x = locrevtaxes_stu, 
                  y = meanpctprof, 
                  color = subgroup)) +
  scale_x_log10(labels = scales::dollar) +
  theme_minimal() +
  theme(plot.title.position = "plot",
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) +
  labs(title = "New Jersey")
```

```{r amy-viz3-prelim3}
# Fitting a line over data points for local revenue x meanpctprof by state
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "all") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  geom_smooth(method = "lm") +
  facet_wrap(~stnam) +
  geom_point(alpha = .1) + 
  scale_x_log10(labels = scales::dollar) 
```

```{r amy-viz3-prelim4}
# Scatterplot: Relationship between local revenue from property taxes ($ per student) and mean % proficient, faceted by state, color by subgroup 
viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup != "all") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof, color = subgroup)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar)
```

Scatterplots for each student subgroup between local revenue from property tax and % proficient, faceted by state. The subgroup is indicated in the title. 

```{r amy-viz3-prelim5}
# Scatterplots: Relationship between local revenue from property taxes ($ per student) and mean % proficient, faceted by state for each subgroup 

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "mam") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "American Indian/Alaska Native")

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "mas") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Asian/Pacific Islander")

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "mhi") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Hispanic/Latino")

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "mbl") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Black")

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "mwh") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "White")

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "mtr") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Multiracial")

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "cwd") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Students with Disabilities")

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "ecd") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Economically Disadvantaged")

viz3_rla00long_fiscal_2010 %>% 
  filter(subgroup == "lep") %>% 
  ggplot(aes(x = locrev_stu, y = meanpctprof)) +
  facet_wrap(~stnam) +
  geom_point(alpha = .4) + 
  scale_x_log10(labels = scales::dollar) +
  labs(title = "Limited English Proficiency")

#These were all great explorations! Information presented by subgroup on the same map is hard to interpret because there are so many colors. I don't know what's a better alterative. Maybe, just focusing on some states and separating the faceted graphs into their individual graphs because there is a lot of information being conveyed together. 
```
